{{- if .Values.backup.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pg.fullname" . }}-backup
  labels:
    {{- include "pg.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup
data:
  backup.sh: |
    #!/bin/bash
    set -euo pipefail

    for var in POSTGRES_HOST POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB S3_ENDPOINT S3_BUCKET S3_ACCESS_KEY S3_SECRET_KEY S3_PREFIX RETENTION_DAYS; do
      if [ -z "${!var}" ]; then
        echo "ERROR: Required environment variable $var is not set"
        exit 1
      fi
    done

    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    DUMP_FILE="/tmp/backup_${TIMESTAMP}.dump"
    S3_PATH="${S3_BUCKET}/${S3_PREFIX}/backup_${TIMESTAMP}.dump"

    echo "Installing curl..."
    apt-get update -qq && apt-get install -y -qq curl > /dev/null

    echo "Downloading mc client..."
    curl -fsSL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
    chmod +x /usr/local/bin/mc

    echo "Configuring S3 alias..."
    mc alias set s3 "$S3_ENDPOINT" "$S3_ACCESS_KEY" "$S3_SECRET_KEY"

    echo "Starting pg_dump..."
    PGPASSWORD="$POSTGRES_PASSWORD" pg_dump -Fc -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -f "$DUMP_FILE"
    echo "pg_dump completed: $(du -h "$DUMP_FILE" | cut -f1)"

    echo "Uploading to s3/${S3_PATH}..."
    mc cp "$DUMP_FILE" "s3/${S3_PATH}"

    echo "Verifying upload..."
    mc ls "s3/${S3_PATH}"

    rm -f "$DUMP_FILE"

    echo "Running retention cleanup (removing backups older than ${RETENTION_DAYS} days)..."
    mc find "s3/${S3_BUCKET}/${S3_PREFIX}/" --older-than "${RETENTION_DAYS}d" --exec "mc rm {}"

    echo "Backup completed successfully"
{{- end }}
