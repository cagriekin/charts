{{- if and .Values.postgresql.enabled (not .Values.postgresql.existingSecret) }}
{{- $user := include "pgvector.postgresql.username" . -}}
{{- $password := include "pgvector.postgresql.resolvedPassword" . -}}
{{- $database := include "pgvector.postgresql.database" . -}}
{{- $secretName := include "pgvector.postgresql.secretName" . -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  annotations:
    helm.sh/resource-policy: keep
  labels:
    {{- include "pgvector.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgresql-secret
type: Opaque
stringData:
  postgres-password: {{ $password | quote }}
  postgres-user: {{ $user | quote }}
  postgres-database: {{ $database | quote }}
  postgres-host: {{ include "pgvector.fullname" . }}-postgresql-master.{{ .Release.Namespace }}.svc.cluster.local
  postgres-port: "5432"
  postgres-url: {{ include "pgvector.postgresql.connectionString" . | quote }}
  replica-host: {{ include "pgvector.fullname" . }}-postgresql-replica.{{ .Release.Namespace }}.svc.cluster.local
  replica-port: "5432"
  replica-url: postgresql://{{ $user }}:{{ $password }}@{{ include "pgvector.fullname" . }}-postgresql-replica.{{ .Release.Namespace }}.svc.cluster.local:5432/{{ $database }}?sslmode=disable
{{- if .Values.postgresql.pgbouncer.enabled }}
  pgbouncer-host: {{ include "pgvector.fullname" . }}-pgbouncer.{{ .Release.Namespace }}.svc.cluster.local
  pgbouncer-port: "{{ .Values.postgresql.pgbouncer.service.port }}"
  pgbouncer-url: postgresql://{{ $user }}:{{ $password }}@{{ include "pgvector.fullname" . }}-pgbouncer.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.postgresql.pgbouncer.service.port }}/{{ $database }}?sslmode=disable
{{- end }}
{{- if .Values.postgresql.haproxy.enabled }}
  haproxy-host: {{ include "pgvector.fullname" . }}-haproxy.{{ .Release.Namespace }}.svc.cluster.local
  haproxy-port: "{{ .Values.postgresql.haproxy.service.port }}"
  haproxy-url: postgresql://{{ $user }}:{{ $password }}@{{ include "pgvector.fullname" . }}-haproxy.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.postgresql.haproxy.service.port }}/{{ $database }}?sslmode=disable
{{- end }}
{{- end }}
